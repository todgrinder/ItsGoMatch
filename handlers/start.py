"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏: /start, /help, –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è.
"""

from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import CommandStart, Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
import aiosqlite

from config import GENDER_LABELS
from keyboards.inline import main_menu_kb, gender_kb, cancel_kb
from database import queries as db_queries

router = Router()


# ==================== FSM –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ====================

class RegistrationFSM(StatesGroup):
    waiting_username = State()
    waiting_gender = State()
    waiting_rating = State()


# ==================== –ö–û–ú–ê–ù–î–´ ====================

@router.message(CommandStart())
async def cmd_start(message: Message, db: aiosqlite.Connection, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start."""
    user_id = message.from_user.id
    telegram_username = message.from_user.username  # –ü–æ–ª—É—á–∞–µ–º @username –∏–∑ Telegram
    
    # –û—á–∏—â–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.clear()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–î
    user = await db_queries.get_user(db, user_id)
    
    if user is None:
        # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî —Å–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –∏ –Ω–∞—á–∏–Ω–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
        await db_queries.create_user(db, user_id, telegram_username)
        
        await state.set_state(RegistrationFSM.waiting_username)
        await message.answer(
            "üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>\n\n"
            "–Ø –±–æ—Ç –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä –∏ –∫–æ–º–∞–Ω–¥ –Ω–∞ —Ç—É—Ä–Ω–∏—Ä—ã.\n\n"
            "–î–ª—è –Ω–∞—á–∞–ª–∞ –¥–∞–≤–∞–π –∑–∞–ø–æ–ª–Ω–∏–º —Ç–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.\n\n"
            "üìõ <b>–®–∞–≥ 1/3:</b> –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è (–Ω–∏–∫–Ω–µ–π–º):",
            reply_markup=cancel_kb(),
            parse_mode="HTML"
        )
    else:
        # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º telegram_username (–º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è)
        if user.get("telegram_username") != telegram_username:
            await db_queries.update_telegram_username(db, user_id, telegram_username)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–µ–Ω –ª–∏ –ø—Ä–æ—Ñ–∏–ª—å
        profile_complete = await db_queries.is_profile_complete(db, user_id)
        
        if not profile_complete:
            # –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —à–∞–≥ –Ω—É–∂–µ–Ω
            if user.get("username") is None:
                await state.set_state(RegistrationFSM.waiting_username)
                await message.answer(
                    "üëã <b>–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º!</b>\n\n"
                    "–î–∞–≤–∞–π –∑–∞–≤–µ—Ä—à–∏–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.\n\n"
                    "üìõ <b>–®–∞–≥ 1/3:</b> –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è (–Ω–∏–∫–Ω–µ–π–º):",
                    reply_markup=cancel_kb(),
                    parse_mode="HTML"
                )
            elif user.get("gender") is None:
                await state.set_state(RegistrationFSM.waiting_gender)
                await message.answer(
                    f"üëã <b>–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {user['username']}!</b>\n\n"
                    "–î–∞–≤–∞–π –∑–∞–≤–µ—Ä—à–∏–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.\n\n"
                    "üöª <b>–®–∞–≥ 2/3:</b> –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø–æ–ª:",
                    reply_markup=gender_kb(),
                    parse_mode="HTML"
                )
            elif user.get("rating") is None:
                await state.set_state(RegistrationFSM.waiting_rating)
                await message.answer(
                    f"üëã <b>–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {user['username']}!</b>\n\n"
                    "–î–∞–≤–∞–π –∑–∞–≤–µ—Ä—à–∏–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.\n\n"
                    "üìä <b>–®–∞–≥ 3/3:</b> –í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–∫—É—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ (—á–∏—Å–ª–æ):",
                    parse_mode="HTML"
                )
        else:
            # –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            await show_main_menu(message, user)


async def show_main_menu(message: Message, user: dict = None):
    """–ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."""
    if user:
        greeting = f"üëã –ü—Ä–∏–≤–µ—Ç, <b>{user.get('username', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}</b>!\n\n"
    else:
        greeting = ""
    
    await message.answer(
        f"{greeting}"
        "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=main_menu_kb(),
        parse_mode="HTML"
    )


@router.message(Command("help"))
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /help ‚Äî —á–∞—Å—Ç—å 1."""
    help_text_1 = """
üìñ <b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–æ—Ç (1/3)</b>

–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –∏ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ç—É—Ä–Ω–∏—Ä–∞—Ö –∏ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è—Ö.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

<b>üéØ –û–°–ù–û–í–ù–û–ô –ü–†–ò–ù–¶–ò–ü:</b>

1Ô∏è‚É£ –ö—Ç–æ-—Ç–æ —Å–æ–∑–¥–∞—ë—Ç <b>—Ç—É—Ä–Ω–∏—Ä</b> (—Å–æ–±—ã—Ç–∏–µ)
2Ô∏è‚É£ –£—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç —Å–µ–±—è –≤ —Ç—É—Ä–Ω–∏—Ä, —Å–æ–∑–¥–∞–≤–∞—è <b>–∑–∞—è–≤–∫–∏</b>
3Ô∏è‚É£ –î—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ –∏—â—É—Ç –∑–∞—è–≤–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç <b>–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</b>
4Ô∏è‚É£ –í–ª–∞–¥–µ–ª–µ—Ü –∑–∞—è–≤–∫–∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç/–æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
5Ô∏è‚É£ –ö–æ–≥–¥–∞ –∑–∞—è–≤–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ ‚Äî —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è <b>–ø–∞—Ä–∞/–∫–æ–º–∞–Ω–¥–∞</b>
6Ô∏è‚É£ –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥—Ä—É–≥ –¥—Ä—É–≥–∞

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

<b>üìã –¢–£–†–ù–ò–†–´:</b>

<b>–°–æ–∑–¥–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä:</b> /create_event
‚Ä¢ –£–∫–∞–∑—ã–≤–∞–µ—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ç–∏–ø (–ø–∞—Ä—ã –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã)
‚Ä¢ –î–ª—è –∫–æ–º–∞–Ω–¥ ‚Äî –≤—ã–±–∏—Ä–∞–µ—Ç–µ —Ä–∞–∑–º–µ—Ä (3-6 —á–µ–ª–æ–≤–µ–∫)
‚Ä¢ –ú–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è
‚Ä¢ –î–æ–±–∞–≤–ª—è–µ—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

<b>–ù–∞–π—Ç–∏ —Ç—É—Ä–Ω–∏—Ä:</b> /list_events –∏–ª–∏ üîé –ü–æ–∏—Å–∫ —Ç—É—Ä–Ω–∏—Ä–æ–≤
‚Ä¢ –í–∏–¥–∏—Ç–µ –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ç—É—Ä–Ω–∏—Ä—ã
‚Ä¢ –†—è–¥–æ–º —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ø–æ–∫–∞–∑–∞–Ω–∞ –¥–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è
‚Ä¢ –¢—É—Ä–Ω–∏—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –ø–æ—Å–ª–µ –¥–∞—Ç—ã

<b>–ú–æ–∏ —Ç—É—Ä–Ω–∏—Ä—ã:</b> /my_events –∏–ª–∏ üìã –ú–æ–∏ —Ç—É—Ä–Ω–∏—Ä—ã
‚Ä¢ –°–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤
‚Ä¢ –ú–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —Ç—É—Ä–Ω–∏—Ä –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ

<b>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä:</b>
‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ —Å–≤–æ–π —Ç—É—Ä–Ω–∏—Ä ‚Üí ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
‚Ä¢ –ú–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å: –Ω–∞–∑–≤–∞–Ω–∏–µ, –¥–∞—Ç—É, –æ–ø–∏—Å–∞–Ω–∏–µ
‚Ä¢ –¢–∏–ø –∏ —Ä–∞–∑–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã –∏–∑–º–µ–Ω–∏—Ç—å –Ω–µ–ª—å–∑—è
"""
    
    help_text_2 = """
üìñ <b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–æ—Ç (2/3)</b>

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

<b>üì¶ –ó–ê–Ø–í–ö–ò:</b>

<b>–î–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è –æ–¥–Ω–æ–≥–æ:</b>
‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ —Ç—É—Ä–Ω–∏—Ä ‚Üí ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è
‚Ä¢ –î–ª—è –ø–∞—Ä: —Å—Ä–∞–∑—É —Å–æ–∑–¥–∞—ë—Ç–µ –∑–∞—è–≤–∫—É
‚Ä¢ –î–ª—è –∫–æ–º–∞–Ω–¥: –≤—ã–±–∏—Ä–∞–µ—Ç–µ ¬´üë§ –î–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è –æ–¥–Ω–æ–≥–æ¬ª
‚Ä¢ –ü–∏—à–µ—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–º–æ–∂–µ—Ç–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)

<b>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É:</b>
‚Ä¢ –î–ª—è –∫–æ–º–∞–Ω–¥–Ω—ã—Ö —Ç—É—Ä–Ω–∏—Ä–æ–≤ –≤—ã–±–∏—Ä–∞–µ—Ç–µ ¬´üë• –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É¬ª
‚Ä¢ –£–∫–∞–∑—ã–≤–∞–µ—Ç–µ Telegram username —Ç–∏–º–º–µ–π—Ç–æ–≤
‚Ä¢ –§–æ—Ä–º–∞—Ç: <code>@user1 @user2 @user3</code>
‚Ä¢ –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–µ –≤—Å–µ—Ö ‚Äî –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –Ω–∞–π–¥—É—Ç –ø–æ–∑–∂–µ
‚Ä¢ –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–æ—Ç–µ

<b>–ù–∞–π—Ç–∏ –∑–∞—è–≤–∫–∏:</b> /search &lt;event_id&gt;
‚Ä¢ –ò–ª–∏ –≤ —Ç—É—Ä–Ω–∏—Ä–µ –Ω–∞–∂–º–∏—Ç–µ üîé –ü–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω—ã—Ö

<b>–î–ª—è –ø–∞—Ä –≤—ã —É–≤–∏–¥–∏—Ç–µ:</b>
‚Ä¢ üë®/üë© –ü–æ–ª –∏–≥—Ä–æ–∫–∞
‚Ä¢ üìõ –ò–º—è
‚Ä¢ üìä –†–µ–π—Ç–∏–Ω–≥

<b>–î–ª—è –∫–æ–º–∞–Ω–¥ –≤—ã —É–≤–∏–¥–∏—Ç–µ:</b>
‚Ä¢ üë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (3/5)
‚Ä¢ ‚≠ê –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –∫–æ–º–∞–Ω–¥—ã

<b>–ú–æ–∏ –∑–∞—è–≤–∫–∏:</b> /my_applications
‚Ä¢ –í—Å–µ –≤–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏
‚Ä¢ üì© –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
‚Ä¢ –ú–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å, —É–ø—Ä–∞–≤–ª—è—Ç—å, –ø–æ–∫–∏–¥–∞—Ç—å
"""
    
    help_text_3 = """
üìñ <b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–æ—Ç (3/3)</b>

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

<b>üì® –ó–ê–ü–†–û–°–´:</b>

<b>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å:</b>
‚Ä¢ –ù–∞–π–¥–∏—Ç–µ –∑–∞—è–≤–∫—É ‚Üí –ø—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª–∏
‚Ä¢ –ù–∞–∂–º–∏—Ç–µ ‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
‚Ä¢ –í–ª–∞–¥–µ–ª–µ—Ü –∑–∞—è–≤–∫–∏ –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

<b>–í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:</b>
‚Ä¢ –ü—Ä–∏—Ö–æ–¥—è—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∏–≥—Ä–æ–∫–µ
‚Ä¢ –í –∑–∞—è–≤–∫–µ –ø–æ–∫–∞–∑–∞–Ω—ã –∫–Ω–æ–ø–∫–∏: ‚úÖ –ü—Ä–∏–Ω—è—Ç—å / ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
‚Ä¢ –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã: /accept &lt;id&gt; / /reject &lt;id&gt;

<b>–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø—Ä–æ—Å–æ–≤:</b>
‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ –∑–∞—è–≤–∫—É ‚Üí üëÄ –í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã
‚Ä¢ –ò–ª–∏ /my_applications ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

<b>‚ùì –ß–ê–°–¢–´–ï –í–û–ü–†–û–°–´:</b>

<b>Q:</b> –ö–∞–∫ –Ω–∞–π—Ç–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –¥–ª—è —Ç—É—Ä–Ω–∏—Ä–∞?
<b>A:</b> –ù–∞–π–¥–∏—Ç–µ —Ç—É—Ä–Ω–∏—Ä ‚Üí –ü–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω—ã—Ö ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É ‚Üí –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è

<b>Q:</b> –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –∏–∑ –¥—Ä—É–∑–µ–π?
<b>A:</b> –û—Ç–∫—Ä–æ–π—Ç–µ —Ç—É—Ä–Ω–∏—Ä ‚Üí –î–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è ‚Üí –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É ‚Üí —É–∫–∞–∂–∏—Ç–µ @username –¥—Ä—É–∑–µ–π

<b>Q:</b> –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å –≤—Ö–æ–¥—è—â–∏–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏?
<b>A:</b> –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª, —Ä–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–∞ –∏ –ø—Ä–∏–º–∏—Ç–µ –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç–µ

<b>Q:</b> –ö–æ–≥–¥–∞ —è –ø–æ–ª—É—á—É –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤?
<b>A:</b> –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∑–∞—è–≤–∫–∞ –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–æ–ª–Ω–µ–Ω–∞

<b>Q:</b> –ú–æ–∂–Ω–æ –ª–∏ –ø–æ–∫–∏–Ω—É—Ç—å –∑–∞—è–≤–∫—É?
<b>A:</b> –î–∞, –µ—Å–ª–∏ –≤—ã –Ω–µ —Å–æ–∑–¥–∞—Ç–µ–ª—å: –∑–∞—è–≤–∫–∞ ‚Üí üö™ –ü–æ–∫–∏–Ω—É—Ç—å –∑–∞—è–≤–∫—É

<b>Q:</b> –ú–æ–∂–Ω–æ –ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä?
<b>A:</b> –î–∞, –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ, –¥–∞—Ç—É, –æ–ø–∏—Å–∞–Ω–∏–µ

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

<b>üõ°Ô∏è –ü–†–ò–í–ê–¢–ù–û–°–¢–¨:</b>

‚Ä¢ –í–∞—à Telegram username –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø
‚Ä¢ –ù–∏–∫–∞–∫–∏–µ –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

–£–¥–∞—á–∏ –≤ –ø–æ–∏—Å–∫–µ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤! üèÜ
"""
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ø—Ä–∞–≤–∫—É –ø–æ —á–∞—Å—Ç—è–º
    await message.answer(help_text_1, parse_mode="HTML")
    await message.answer(help_text_2, parse_mode="HTML")
    await message.answer(help_text_3, parse_mode="HTML")



# ==================== FSM: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ====================

@router.message(RegistrationFSM.waiting_username)
async def fsm_registration_username(message: Message, state: FSMContext, db: aiosqlite.Connection):
    """–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª –∏–º—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏."""
    username = message.text.strip()
    
    if not username:
        await message.answer(
            "‚ùå –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.\n\n"
            "üìõ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è (–Ω–∏–∫–Ω–µ–π–º):"
        )
        return
    
    if len(username) > 50:
        await message.answer(
            "‚ùå –ò–º—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤).\n\n"
            "üìõ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è (–Ω–∏–∫–Ω–µ–π–º):"
        )
        return
    
    user_id = message.from_user.id
    telegram_username = message.from_user.username
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º telegram_username –≤ –ë–î
    await db_queries.update_user_profile(db, user_id, username=username, telegram_username=telegram_username)
    
    await state.set_state(RegistrationFSM.waiting_gender)
    
    await message.answer(
        f"‚úÖ –ò–º—è: <b>{username}</b>\n\n"
        "üöª <b>–®–∞–≥ 2/3:</b> –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø–æ–ª:",
        reply_markup=gender_kb(),
        parse_mode="HTML"
    )


@router.callback_query(RegistrationFSM.waiting_gender, F.data.startswith("set_gender:"))
async def fsm_registration_gender(callback: CallbackQuery, state: FSMContext, db: aiosqlite.Connection):
    """–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –ø–æ–ª –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏."""
    gender = callback.data.split(":")[1]
    user_id = callback.from_user.id
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª –≤ –ë–î
    await db_queries.update_gender(db, user_id, gender)
    
    await state.set_state(RegistrationFSM.waiting_rating)
    await callback.message.edit_text(
        f"‚úÖ –ü–æ–ª: <b>{GENDER_LABELS[gender]}</b>\n\n"
        "üìä <b>–®–∞–≥ 3/3:</b> –í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–∫—É—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ (—á–∏—Å–ª–æ):",
        parse_mode="HTML"
    )
    await callback.answer()


@router.message(RegistrationFSM.waiting_rating)
async def fsm_registration_rating(message: Message, state: FSMContext, db: aiosqlite.Connection):
    """–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª —Ä–µ–π—Ç–∏–Ω–≥ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏."""
    try:
        rating = float(message.text.strip().replace(",", "."))
    except ValueError:
        await message.answer(
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.\n\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: <code>1500</code> –∏–ª–∏ <code>1234.5</code>",
            parse_mode="HTML"
        )
        return
    
    if rating < 0 or rating > 100000:
        await message.answer(
            "‚ùå –†–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0 –¥–æ 100 000.\n\n"
            "üìä –í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ä–µ–π—Ç–∏–Ω–≥:"
        )
        return
    
    user_id = message.from_user.id
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –≤ –ë–î
    await db_queries.update_rating(db, user_id, rating)
    
    await state.clear()
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = await db_queries.get_user(db, user_id)
    gender_label = GENDER_LABELS.get(user.get("gender"), "–ù–µ —É–∫–∞–∑–∞–Ω")
    
    # –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    await db_queries.create_log(db, "user_registered", f"user_id={user_id}, username={user.get('username')}")
    
    await message.answer(
        "üéâ <b>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</b>\n\n"
        f"üìõ –ò–º—è: {user.get('username')}\n"
        f"üöª –ü–æ–ª: {gender_label}\n"
        f"üìä –†–µ–π—Ç–∏–Ω–≥: {rating}\n\n"
        "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º!",
        reply_markup=main_menu_kb(),
        parse_mode="HTML"
    )


# ==================== CALLBACKS ====================

@router.callback_query(F.data == "help")
async def cb_help(callback: CallbackQuery):
    """–ö–Ω–æ–ø–∫–∞ –ø–æ–º–æ—â–∏ (–∫—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞)."""
    help_text = """
üìñ <b>–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞</b>

<b>üèÜ –¢—É—Ä–Ω–∏—Ä—ã</b>
–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ç—É—Ä–Ω–∏—Ä—ã –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º

<b>üì¶ –ó–∞—è–≤–∫–∏</b>
–î–æ–±–∞–≤–ª—è–π—Ç–µ —Å–µ–±—è (–∏–ª–∏ –∫–æ–º–∞–Ω–¥—É) –≤ —Ç—É—Ä–Ω–∏—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤

<b>üîé –ü–æ–∏—Å–∫</b>
–ò—â–∏—Ç–µ –∑–∞—è–≤–∫–∏ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã

<b>üì® –ó–∞–ø—Ä–æ—Å—ã</b>
–ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω—è–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

<b>üéâ –ì—Ä—É–ø–ø—ã</b>
–ö–æ–≥–¥–∞ –∑–∞—è–≤–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ ‚Äî –≤—Å–µ –ø–æ–ª—É—á–∞—é—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥—Ä—É–≥ –¥—Ä—É–≥–∞

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

<b>–ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</b> /help
"""
    await callback.message.edit_text(
        help_text,
        reply_markup=main_menu_kb(),
        parse_mode="HTML"
    )
    await callback.answer()


@router.callback_query(F.data == "back_main")
async def cb_back_main(callback: CallbackQuery, state: FSMContext, db: aiosqlite.Connection):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."""
    await state.clear()
    
    user = await db_queries.get_user(db, callback.from_user.id)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º telegram_username –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
    telegram_username = callback.from_user.username
    if user and user.get("telegram_username") != telegram_username:
        await db_queries.update_telegram_username(db, callback.from_user.id, telegram_username)
    
    username = user.get("username", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å") if user else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    
    await callback.message.edit_text(
        f"üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n"
        f"–ü—Ä–∏–≤–µ—Ç, <b>{username}</b>! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=main_menu_kb(),
        parse_mode="HTML"
    )
    await callback.answer()


@router.callback_query(F.data == "cancel")
async def cb_cancel(callback: CallbackQuery, state: FSMContext, db: aiosqlite.Connection):
    """–û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è."""
    await state.clear()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
    user_id = callback.from_user.id
    profile_complete = await db_queries.is_profile_complete(db, user_id)
    
    if profile_complete:
        await callback.message.edit_text(
            "‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.\n\n"
            "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>",
            reply_markup=main_menu_kb(),
            parse_mode="HTML"
        )
    else:
        await callback.message.edit_text(
            "‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.\n\n"
            "‚ö†Ô∏è –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω –¥–æ –∫–æ–Ω—Ü–∞.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.",
            parse_mode="HTML"
        )
    await callback.answer()


@router.callback_query(F.data == "noop")
async def cb_noop(callback: CallbackQuery):
    """–ü—É—Å—Ç–æ–π callback (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç)."""
    await callback.answer()

# –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π –∫–Ω–æ–ø–∫–∏ skip (–µ—Å–ª–∏ –µ—ë –Ω–∞–∂–∞–ª–∏ –≤–Ω–µ FSM)

@router.callback_query(F.data == "skip")
async def cb_skip_fallback(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤–Ω–µ FSM."""
    await callback.answer("‚ùå –ù–µ—á–µ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å", show_alert=True)

